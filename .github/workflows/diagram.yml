name: Create diagram
on:
  workflow_dispatch: {}
  push:
    branches:
      - master
jobs:
  get_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.1
        with:
          fetch-depth: 0

      - name: Update diagram
        uses: githubocto/repo-visualizer@main
        with:
          excluded_paths: "ignore,.github"
          output_file: "diagram.svg"

      - name: Create and push branch with timestamped diagram
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git checkout --orphan repo-visualizer
          git rm -rf .
          timestamp=$(date +"%Y%m%d_%H%M%S")
          mv diagram.svg "diagram_${timestamp}.svg"
          git add "diagram_${timestamp}.svg"
          git commit -m "Update repository visualization - $timestamp"
          git push origin repo-visualizer --force
